<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xolo AI - Asistente de Programaci√≥n</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* ========================================
           MODAL DE INICIO
        ======================================== */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        .modal-overlay.hidden { display: none; }

        .modal {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            max-width: 480px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .modal-header h2 {
            color: #1a1a2e;
            font-size: 1.4rem;
            margin-bottom: 0.25rem;
        }

        .modal-header p {
            color: #666;
            font-size: 0.85rem;
        }

        .section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #667eea;
            margin: 1rem 0 0.5rem 0;
            padding-top: 0.75rem;
            border-top: 1px solid #eee;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .section-title:first-of-type {
            border-top: none;
            margin-top: 0.5rem;
        }

        .modal label {
            display: block;
            font-size: 0.8rem;
            color: #555;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .modal label small {
            color: #999;
            font-weight: normal;
        }

        .modal input, .modal textarea, .modal select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.85rem;
            margin-bottom: 0.6rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .modal textarea {
            resize: vertical;
            min-height: 50px;
        }

        .modal input:focus, .modal textarea:focus, .modal select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Identity Selector en Modal */
        .identity-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            margin-bottom: 0.6rem;
        }

        .identity-option {
            padding: 8px 4px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .identity-option:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.25);
        }

        .identity-option.selected {
            border-color: #333;
            box-shadow: 0 0 0 2px white, 0 3px 10px rgba(0,0,0,0.3);
        }

        /* Checkbox nuevo estudiante */
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: #f0f4ff;
            border-radius: 6px;
            margin-bottom: 0.6rem;
        }

        .checkbox-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
            accent-color: #667eea;
        }

        .checkbox-row label {
            margin: 0;
            font-size: 0.85rem;
            color: #333;
        }

        .modal .btn-start {
            width: 100%;
            padding: 0.875rem 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.75rem;
            transition: opacity 0.2s, transform 0.2s;
        }

        .modal .btn-start:hover {
            opacity: 0.95;
            transform: translateY(-1px);
        }

        .modal .btn-start:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* ========================================
           LAYOUT PRINCIPAL
        ======================================== */
        .app-container {
            display: none;
            flex: 1;
            height: 100vh;
            transition: background 0.3s ease;
        }

        .app-container.active {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 60px;
            padding: 2rem;
        }

        /* Logo Section */
        .logo-section {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .logo-section img {
            max-width: 280px;
            height: auto;
            filter: drop-shadow(0 10px 30px rgba(0,0,0,0.3));
            animation: fadeIn 1s ease-out forwards;
            opacity: 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Chat Section */
        .chat-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #chat-container {
            width: 400px;
            height: calc(100vh - 4rem);
            max-height: 700px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
            background: white;
        }

        /* ========================================
           FULLSCREEN MODAL
        ======================================== */
        .fullscreen-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.95);
            z-index: 99999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px;
        }

        .fullscreen-modal.active { display: flex; }

        .fullscreen-modal img {
            max-width: 95%;
            max-height: 85vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 0 50px rgba(255,255,255,0.1);
        }

        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 40px;
            color: white;
            cursor: pointer;
            background: none;
            border: none;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .fullscreen-close:hover { opacity: 1; }

        .fullscreen-hint {
            color: rgba(255,255,255,0.6);
            margin-top: 15px;
            font-size: 14px;
        }

        /* Hidden renderer */
        #makecode-renderer { 
            position: absolute; 
            left: -9999px; 
            width: 1px; 
            height: 1px; 
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .app-container.active {
                flex-direction: column;
                gap: 30px;
                padding: 1.5rem;
            }
            
            .logo-section img {
                max-width: 180px;
            }
            
            #chat-container {
                width: 100%;
                max-width: 400px;
                height: calc(100vh - 280px);
            }
        }

        @media (max-width: 480px) {
            .identity-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .logo-section img {
                max-width: 140px;
            }
            
            .app-container.active {
                gap: 20px;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- ========================================
         MODAL DE INICIO
    ======================================== -->
    <div class="modal-overlay" id="startModal">
        <div class="modal">
            <div class="modal-header">
                <h2>üêï Xolo AI</h2>
                <p>Configura tu sesi√≥n de aprendizaje</p>
            </div>

            <div class="section-title">üé® Elige tu Xolo</div>
            <div class="identity-grid" id="identityGrid"></div>

            <div class="section-title">üìå Identificaci√≥n</div>
            <label>ID de Sesi√≥n <small>(requerido)</small></label>
            <input type="text" id="userIdInput" placeholder="Ej: estudiante_001" autocomplete="off">

            <div class="section-title">üë§ Perfil del Estudiante</div>
            
            <label>¬øEs tu primera vez? <small>- El chatbot preguntar√° tu info</small></label>
            <select id="studentNew">
                <option value="true" selected>S√≠, es mi primera vez</option>
                <option value="false">No, ya tengo perfil</option>
            </select>
            
            <label>Apodo <small>- C√≥mo te llaman</small></label>
            <input type="text" id="studentNickname" placeholder="Ej: Santi">

            <label>Intereses <small>- Qu√© te gusta</small></label>
            <textarea id="studentInterests" placeholder="Ej: videojuegos, robots, m√∫sica"></textarea>

            <label>Estilo de aprendizaje <small>- C√≥mo aprendes mejor</small></label>
            <textarea id="studentLearning" placeholder="Ej: visual, con ejemplos pr√°cticos"></textarea>

            <label>Motivaci√≥n <small>- Qu√© te motiva</small></label>
            <textarea id="studentGamification" placeholder="Ej: retos, competencias, logros"></textarea>

            <div class="section-title">üìö Configuraci√≥n de Clase</div>
            
            <label>Objetivo <small>- Qu√© aprender√°s hoy</small></label>
            <textarea id="classObjective" placeholder="Ej: Programar un sem√°foro con micro:bit"></textarea>

            <label>Contenido <small>- Tema espec√≠fico</small></label>
            <textarea id="classPrompt" placeholder="Ej: Uso de LEDs y delays"></textarea>

            <label>Ruta <small>- Pasos de la sesi√≥n</small></label>
            <textarea id="classPath" placeholder="Ej: Intro ‚Üí Demo ‚Üí Pr√°ctica ‚Üí Reto"></textarea>

            <button class="btn-start" id="btnStart" disabled>üöÄ Comenzar Sesi√≥n</button>
        </div>
    </div>

    <!-- ========================================
         APLICACI√ìN PRINCIPAL
    ======================================== -->
    <div class="app-container" id="appContainer">
        <!-- Logo Section -->
        <div class="logo-section">
            <img src="https://raw.githubusercontent.com/Gnius-Club/Xolo_2_Images_Databank/refs/heads/main/Xolo_2_Branding/XOLO_2.0_LOGO_W.png" alt="Xolo AI Logo">
        </div>

        <!-- Chat Section -->
        <div class="chat-section">
            <div id="chat-container"></div>
        </div>
    </div>

    <!-- ========================================
         FULLSCREEN MODAL
    ======================================== -->
    <div class="fullscreen-modal" id="fullscreenModal">
        <button class="fullscreen-close" onclick="closeFullscreen()">&times;</button>
        <img id="fullscreenImg" src="" alt="Bloques MakeCode">
        <p class="fullscreen-hint">ESC o √ó para cerrar</p>
    </div>

    <!-- MakeCode Renderer IFrame (EST√ÅTICO como en versi√≥n funcional) -->
    <iframe 
        id="makecode-renderer" 
        src="https://makecode.microbit.org/--docs?render=1&forcelang=es"
        sandbox="allow-scripts allow-same-origin"
    ></iframe>

    <script>
        // ========================================
        // CONFIGURACI√ìN
        // ========================================
        const VOICEFLOW_PROJECT_ID = '6939acf1a9d88d0b36fcdacf';
        const MAKECODE_URL = 'https://makecode.microbit.org/';

        // ========================================
        // IDENTIDADES XOLO AI
        // ========================================
        const xoloIdentities = [
            { id: 'xolo3', name: 'Xolo 3', gradient: ['#0000ff', '#00ffff'], solidColor: '#0080ff', userBubbleText: '#ffffff' },
            { id: 'xolo4', name: 'Xolo 4', gradient: ['#0065a8', '#00ff66'], solidColor: '#00ffbf', userBubbleText: '#0f172a' },
            { id: 'xolo5', name: 'Xolo 5', gradient: ['#007bff', '#33ff00'], solidColor: '#00ff4c', userBubbleText: '#0f172a' },
            { id: 'xolo6', name: 'Xolo 6', gradient: ['#00991f', '#ccff00'], solidColor: '#4dff00', userBubbleText: '#0f172a' },
            { id: 'xolo7', name: 'Xolo 7', gradient: ['#ff0022', '#9900ff'], solidColor: '#cc008b', userBubbleText: '#ffffff' },
            { id: 'xolo8', name: 'Xolo 8', gradient: ['#ff7700', '#ff00cc'], solidColor: '#ff3c64', userBubbleText: '#ffffff' },
            { id: 'xolo9', name: 'Xolo 9', gradient: ['#ffae00', '#ff0033'], solidColor: '#ff5619', userBubbleText: '#ffffff' },
            { id: 'xolo10', name: 'Xolo 10', gradient: ['#003380', '#b300ff'], solidColor: '#1300bd', userBubbleText: '#ffffff' },
            { id: 'xolo11', name: 'Xolo 11', gradient: ['#1e0080', '#ff00cc'], solidColor: '#8400bd', userBubbleText: '#ffffff' },
            { id: 'xolo12', name: 'Xolo 12', gradient: ['#660080', '#ff0033'], solidColor: '#bd0084', userBubbleText: '#ffffff' }
        ];

        // ========================================
        // EXTENSIONES MAKECODE (ELECFREAKS + extras)
        // Formato verificado: name=github:user/repo separados por COMA
        // ========================================
        const makeCodeExtensions = [
            // ELECFREAKS Core Extensions
            'nezha2=github:elecfreaks/pxt-nezha2',
            'cutebot=github:elecfreaks/pxt-cutebot',
            'PlanetX=github:elecfreaks/pxt-PlanetX',
            'xgo=github:elecfreaks/pxt-xgo',
            // IoT & Environment
            'iot-environment-kit=github:tinkertanker/pxt-iot-environment-kit',
            // Microsoft Common Extensions
            'neopixel=github:microsoft/pxt-neopixel',
            'servo=github:microsoft/pxt-servo'
        ];
        
        // String de packages para el renderer (separados por COMA - formato verificado)
        const MAKECODE_PACKAGES = makeCodeExtensions.join(',');

        // ========================================
        // ESTADO
        // ========================================
        let currentIdentity = xoloIdentities[0];
        let lastCSS = '';
        let scriptLoaded = false;

        // ========================================
        // ELEMENTOS DOM
        // ========================================
        const startModal = document.getElementById('startModal');
        const appContainer = document.getElementById('appContainer');
        const userIdInput = document.getElementById('userIdInput');
        const btnStart = document.getElementById('btnStart');

        // ========================================
        // INICIALIZAR GRID DE IDENTIDADES
        // ========================================
        function initIdentityGrid() {
            const grid = document.getElementById('identityGrid');
            grid.innerHTML = '';
            
            xoloIdentities.forEach((identity, index) => {
                const option = document.createElement('div');
                option.className = 'identity-option' + (index === 0 ? ' selected' : '');
                option.style.background = `linear-gradient(135deg, ${identity.gradient[0]}, ${identity.gradient[1]})`;
                option.textContent = identity.name.replace('Xolo ', '');
                option.onclick = () => selectIdentity(identity, option);
                grid.appendChild(option);
            });
        }

        function selectIdentity(identity, element) {
            currentIdentity = identity;
            document.querySelectorAll('.identity-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
        }

        // ========================================
        // VALIDACI√ìN
        // ========================================
        userIdInput.addEventListener('input', () => {
            btnStart.disabled = userIdInput.value.trim() === '';
        });

        userIdInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && userIdInput.value.trim() !== '') {
                startSession();
            }
        });

        btnStart.addEventListener('click', startSession);

        // ========================================
        // INICIAR SESI√ìN
        // ========================================
        function startSession() {
            const userId = userIdInput.value.trim();
            
            const studentNewValue = document.getElementById('studentNew').value;
            
            const variables = {
                student_new: studentNewValue,
                student_nickname: document.getElementById('studentNickname').value.trim(),
                student_interests: document.getElementById('studentInterests').value.trim(),
                student_learning: document.getElementById('studentLearning').value.trim(),
                student_gamification: document.getElementById('studentGamification').value.trim(),
                class_objective: document.getElementById('classObjective').value.trim(),
                class_prompt: document.getElementById('classPrompt').value.trim(),
                class_path: document.getElementById('classPath').value.trim()
            };

            console.log('üöÄ Iniciando sesi√≥n:', userId);
            console.log('üë§ student_new:', studentNewValue);
            console.log('üìã Variables:', variables);

            startModal.classList.add('hidden');
            appContainer.classList.add('active');

            applyIdentityColors();
            initVoiceflow(userId, variables);
        }

        // ========================================
        // APLICAR COLORES DE IDENTIDAD
        // ========================================
        function applyIdentityColors() {
            const gradient = `linear-gradient(135deg, ${currentIdentity.gradient[0]}, ${currentIdentity.gradient[1]})`;
            appContainer.style.background = gradient;
            generateAndApplyCSS();
        }

        // ========================================
        // CSS DIN√ÅMICO
        // ========================================
        function generateAndApplyCSS() {
            const identity = currentIdentity;
            const headerBg = `linear-gradient(135deg, ${identity.gradient[0]}, ${identity.gradient[1]})`;
            
            lastCSS = `
.vfrc-header, [class*="Header"]:not([class*="AssistantInfo"]) { background: ${headerBg} !important; }
.vfrc-header *, .vfrc-header [class*="Title"], .vfrc-header [class*="Text"] { color: #ffffff !important; }
.vfrc-assistant-info, [class*="AssistantInfo"], [class*="Welcome"] { color: #0f172a !important; }
.vfrc-assistant-info *, [class*="AssistantInfo"] *, [class*="Welcome"] * { color: #0f172a !important; }
.vfrc-chat, .vfrc-chat--dialog, [class*="Dialog"], [class*="ChatContainer"] { background: #ffffff !important; }
.vfrc-system-response .vfrc-message, [class*="SystemMessage"] { background: #e0e0e0 !important; color: #0f172a !important; border-radius: 12px !important; }
.vfrc-user-response .vfrc-message, [class*="UserMessage"] { background: ${identity.solidColor} !important; color: ${identity.userBubbleText} !important; border-radius: 12px !important; }
.vfrc-button, button[class*="Button"], [class*="ActionButton"] { background: ${identity.gradient[0]} !important; color: #ffffff !important; border: none !important; border-radius: 8px !important; }
.vfrc-chat-input, [class*="InputContainer"], [class*="ChatInput"] { background: #ffffff !important; }
.vfrc-chat-input textarea, .vfrc-chat-input input, [class*="InputField"] { background: #ffffff !important; color: #0f172a !important; }
.vfrc-chat-input button, [class*="SendButton"] { background: ${identity.gradient[0]} !important; color: #ffffff !important; }`;

            injectCSS(lastCSS);
        }

        function injectCSS(css) {
            const inject = (root) => {
                if (!root) return;
                let style = root.querySelector('#vf-custom-css');
                if (!style) {
                    style = document.createElement('style');
                    style.id = 'vf-custom-css';
                    root.appendChild(style);
                }
                style.textContent = css;
                root.querySelectorAll('*').forEach(el => {
                    if (el.shadowRoot) inject(el.shadowRoot);
                });
            };
            
            const container = document.getElementById('chat-container');
            if (container?.shadowRoot) inject(container.shadowRoot);
            document.querySelectorAll('*').forEach(el => {
                if (el.shadowRoot) inject(el.shadowRoot);
            });
        }

        // ========================================
        // FULLSCREEN
        // ========================================
        function openFullscreen(imgSrc) {
            document.getElementById('fullscreenImg').src = imgSrc;
            document.getElementById('fullscreenModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeFullscreen() {
            document.getElementById('fullscreenModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeFullscreen();
        });

        document.getElementById('fullscreenModal').addEventListener('click', (e) => {
            if (e.target.id === 'fullscreenModal') closeFullscreen();
        });

        // ========================================
        // MAKECODE RENDERER (SIMPLIFICADO)
        // ========================================
        window.MakeCodeRenderer = {
            iframe: null,
            isReady: false,
            queue: [],
            callbacks: {},
            requestId: 0,

            init: function() {
                this.iframe = document.getElementById('makecode-renderer');
                
                window.addEventListener('message', (event) => {
                    if (!event.origin.includes('makecode.microbit.org')) return;
                    
                    const data = event.data;
                    if (data.source !== 'makecode') return;

                    if (data.type === 'renderready') {
                        console.log('‚úÖ MakeCode Renderer listo');
                        this.isReady = true;
                        this.processQueue();
                    } 
                    else if (data.type === 'renderblocks') {
                        const callback = this.callbacks[data.id];
                        if (callback) {
                            callback(data);
                            delete this.callbacks[data.id];
                        }
                    }
                });
            },

            render: function(code) {
                return new Promise((resolve, reject) => {
                    const id = 'render-' + (this.requestId++);
                    
                    this.callbacks[id] = (response) => {
                        console.log('üì• Respuesta MakeCode:', response.id, response.error || 'OK');
                        if (response.uri) {
                            resolve({
                                uri: response.uri,
                                width: response.width,
                                height: response.height
                            });
                        } else if (response.error) {
                            reject(new Error(response.error));
                        } else {
                            reject(new Error('Error al renderizar bloques'));
                        }
                    };

                    // Construir mensaje EXACTAMENTE como en el test que funciona
                    const message = {
                        type: 'renderblocks',
                        id: id,
                        code: code,
                        options: {
                            snippetMode: true
                        }
                    };
                    
                    // Agregar packages (formato id√©ntico al test)
                    message.options.package = MAKECODE_PACKAGES;
                    
                    console.log('üì§ Enviando a MakeCode:', JSON.stringify(message.options));

                    if (this.isReady) {
                        this.sendMessage(message);
                    } else {
                        this.queue.push(message);
                    }

                    setTimeout(() => {
                        if (this.callbacks[id]) {
                            delete this.callbacks[id];
                            reject(new Error('Timeout al renderizar'));
                        }
                    }, 30000);
                });
            },

            sendMessage: function(message) {
                if (this.iframe && this.iframe.contentWindow) {
                    this.iframe.contentWindow.postMessage(message, MAKECODE_URL);
                }
            },

            processQueue: function() {
                while (this.queue.length > 0) {
                    const msg = this.queue.shift();
                    this.sendMessage(msg);
                }
            }
        };

        // ========================================
        // FUNCI√ìN AUXILIAR: EXTRAER C√ìDIGO
        // ========================================
        function extractCodeFromTrace(trace) {
            const payload = trace.payload || {};
            
            // Log completo para debug
            console.log('üîç [DEBUG] trace completo:', JSON.stringify(trace, null, 2));
            console.log('üîç [DEBUG] payload:', JSON.stringify(payload, null, 2));
            
            // Intentar m√∫ltiples rutas de extracci√≥n
            let code = null;
            
            // Ruta 1: payload.code directo
            if (payload.code) {
                console.log('‚úÖ C√≥digo encontrado en payload.code');
                code = payload.code;
            }
            // Ruta 2: payload.body.code
            else if (payload.body && payload.body.code) {
                console.log('‚úÖ C√≥digo encontrado en payload.body.code');
                code = payload.body.code;
            }
            // Ruta 3: payload.data.code
            else if (payload.data && payload.data.code) {
                console.log('‚úÖ C√≥digo encontrado en payload.data.code');
                code = payload.data.code;
            }
            // Ruta 4: payload.body es string JSON
            else if (typeof payload.body === 'string') {
                try {
                    const parsed = JSON.parse(payload.body);
                    if (parsed.code) {
                        console.log('‚úÖ C√≥digo encontrado en payload.body (parsed JSON)');
                        code = parsed.code;
                    }
                } catch(e) {
                    console.log('‚ö†Ô∏è payload.body no es JSON v√°lido');
                }
            }
            // Ruta 5: payload es string directo
            else if (typeof payload === 'string') {
                console.log('‚úÖ payload es string directo');
                code = payload;
            }
            // Ruta 6: trace.payload es string
            else if (typeof trace.payload === 'string') {
                console.log('‚úÖ trace.payload es string directo');
                code = trace.payload;
            }
            // Ruta 7: Buscar en message
            else if (payload.message && payload.message.code) {
                console.log('‚úÖ C√≥digo encontrado en payload.message.code');
                code = payload.message.code;
            }
            // Ruta 8: Buscar c√≥digo en cualquier propiedad del payload
            else {
                for (const key of Object.keys(payload)) {
                    if (typeof payload[key] === 'string' && payload[key].includes('basic.')) {
                        console.log(`‚úÖ C√≥digo encontrado en payload.${key}`);
                        code = payload[key];
                        break;
                    }
                }
            }
            
            if (!code) {
                console.error('‚ùå No se pudo extraer c√≥digo. Estructura del trace:', {
                    traceType: trace.type,
                    payloadKeys: Object.keys(payload),
                    payloadTypes: Object.fromEntries(
                        Object.entries(payload).map(([k, v]) => [k, typeof v])
                    )
                });
            }
            
            return code;
        }

        // ========================================
        // EXTENSI√ìN: RENDER BLOQUES MAKECODE
        // ========================================
        const MakeCodeBlocksExtension = {
            name: 'MakeCodeBlocks',
            type: 'response',
            match: ({ trace }) => {
                const isMatch = trace.type === 'render_blocks' || 
                       trace.type === 'ext_render_blocks' || 
                       trace.type === 'RENDER_MAKECODE_BLOCKS' ||
                       (trace.payload && trace.payload.name === 'render_blocks') || 
                       (trace.payload && trace.payload.type === 'render_blocks');
                
                if (isMatch) {
                    console.log('üéØ MakeCodeBlocksExtension MATCH - trace.type:', trace.type);
                }
                return isMatch;
            },
            render: async ({ trace, element }) => {
                if (lastCSS) setTimeout(() => injectCSS(lastCSS), 100);
                
                // Usar la funci√≥n de extracci√≥n mejorada
                const code = extractCodeFromTrace(trace);
                
                if (!code) {
                    element.innerHTML = `
                        <div style="color:#e53e3e;padding:15px;text-align:center;background:#fff5f5;border-radius:8px;margin:8px 0;">
                            <strong>‚ö†Ô∏è No se recibi√≥ c√≥digo</strong>
                            <details style="margin-top:10px;text-align:left;">
                                <summary style="cursor:pointer;color:#666;">Ver datos recibidos (debug)</summary>
                                <pre style="background:#f5f5f5;padding:10px;border-radius:4px;margin-top:5px;overflow-x:auto;font-size:10px;white-space:pre-wrap;">${JSON.stringify(trace, null, 2)}</pre>
                            </details>
                        </div>`;
                    return;
                }

                console.log('üìù C√≥digo a renderizar:', code);

                const container = document.createElement('div');
                container.style.cssText = 'background:#fff;border-radius:12px;padding:12px;margin:8px 0;box-shadow:0 2px 8px rgba(0,0,0,0.1);width:100%;max-width:100%;';
                container.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;padding:20px;color:#666;font-size:14px;">
                    <div style="width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid ${currentIdentity.gradient[0]};border-radius:50%;animation:spin 1s linear infinite;margin-right:10px;"></div>
                    <span>Generando bloques...</span>
                </div>`;
                element.appendChild(container);

                try {
                    const result = await window.MakeCodeRenderer.render(code);
                    console.log('‚úÖ Bloques renderizados:', result);
                    
                    let isScaleMode = true;
                    
                    const imgWrapper = document.createElement('div');
                    imgWrapper.style.cssText = 'width:100%;overflow:hidden;border-radius:8px;background:#f8f9fa;position:relative;';
                    
                    const img = document.createElement('img');
                    img.src = result.uri;
                    img.alt = 'Bloques MakeCode';
                    
                    const applyStyle = () => {
                        if (isScaleMode) {
                            img.style.cssText = 'width:100%!important;max-width:100%!important;height:auto!important;display:block;margin:0 auto;cursor:zoom-in;';
                            imgWrapper.style.overflowX = 'hidden';
                        } else {
                            img.style.cssText = 'width:auto;max-width:none;height:auto;display:block;cursor:grab;';
                            imgWrapper.style.overflowX = 'auto';
                        }
                    };
                    applyStyle();
                    
                    img.onclick = () => {
                        if (isScaleMode) openFullscreen(result.uri);
                    };
                    imgWrapper.appendChild(img);
                    
                    const btnBar = document.createElement('div');
                    btnBar.style.cssText = 'display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;';
                    const btnStyle = `padding:6px 10px;background:${currentIdentity.gradient[0]};color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px;transition:opacity 0.2s;display:flex;align-items:center;gap:4px;`;
                    
                    const toggleBtn = document.createElement('button');
                    toggleBtn.innerHTML = '‚ÜîÔ∏è Scroll';
                    toggleBtn.style.cssText = btnStyle;
                    toggleBtn.onclick = () => {
                        isScaleMode = !isScaleMode;
                        applyStyle();
                        toggleBtn.innerHTML = isScaleMode ? '‚ÜîÔ∏è Scroll' : 'üî≤ Escalar';
                        fullscreenBtn.style.display = isScaleMode ? 'flex' : 'none';
                    };
                    
                    const fullscreenBtn = document.createElement('button');
                    fullscreenBtn.innerHTML = 'üîç Ampliar';
                    fullscreenBtn.style.cssText = btnStyle;
                    fullscreenBtn.onclick = () => openFullscreen(result.uri);
                    
                    const copyBtn = document.createElement('button');
                    copyBtn.innerHTML = 'üìã Copiar';
                    copyBtn.style.cssText = btnStyle;
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(code).then(() => {
                            copyBtn.innerHTML = '‚úÖ Copiado';
                            setTimeout(() => copyBtn.innerHTML = 'üìã Copiar', 2000);
                        });
                    };
                    
                    btnBar.appendChild(toggleBtn);
                    btnBar.appendChild(fullscreenBtn);
                    btnBar.appendChild(copyBtn);
                    
                    const details = document.createElement('details');
                    details.style.cssText = 'margin-top:10px;font-size:11px;';
                    details.innerHTML = `<summary style="cursor:pointer;color:#666;padding:5px 0;">Ver c√≥digo TypeScript</summary>
                    <pre style="background:#f5f5f5;padding:10px;border-radius:4px;margin-top:5px;overflow-x:auto;font-size:11px;white-space:pre-wrap;word-break:break-all;">${code}</pre>`;
                    
                    container.innerHTML = '';
                    container.appendChild(imgWrapper);
                    container.appendChild(btnBar);
                    container.appendChild(details);
                } catch (error) {
                    console.error('‚ùå Error MakeCode:', error);
                    container.innerHTML = `<div style="color:#e53e3e;padding:10px;text-align:center;">‚ö†Ô∏è ${error.message}</div>
                    <pre style="background:#f5f5f5;padding:10px;border-radius:6px;font-size:11px;overflow-x:auto;">${code}</pre>`;
                }
            }
        };

        // ========================================
        // EXTENSI√ìN: GUARDAR INFO DEL ESTUDIANTE
        // ========================================
        const SaveStudentInfoExtension = {
            name: 'SaveStudentInfo',
            type: 'response',
            match: ({ trace }) => {
                return trace.type === 'save_student_info' || 
                       trace.type === 'ext_save_student_info' ||
                       trace.type === 'SAVE_STUDENT_INFO' ||
                       (trace.payload && trace.payload.name === 'save_student_info') || 
                       (trace.payload && trace.payload.type === 'save_student_info');
            },
            render: ({ trace, element }) => {
                const payload = trace.payload || {};
                let data = payload;
                
                if (typeof payload.body === 'string') {
                    try {
                        data = JSON.parse(payload.body);
                    } catch(e) {
                        data = payload;
                    }
                } else if (payload.body) {
                    data = payload.body;
                } else if (payload.data) {
                    data = payload.data;
                }

                console.log('üì• SaveStudentInfo recibido:', data);

                const confirmation = document.createElement('div');
                confirmation.style.cssText = 'background:#d1fae5;border:1px solid #10b981;border-radius:8px;padding:10px;margin:8px 0;font-size:13px;color:#065f46;';
                confirmation.innerHTML = `<strong>‚úÖ Informaci√≥n guardada</strong><br>
                    ${data.student_nickname ? `Apodo: ${data.student_nickname}<br>` : ''}
                    ${data.student_interests ? `Intereses: ${data.student_interests}` : ''}`;
                element.appendChild(confirmation);
            }
        };

        // ========================================
        // INICIALIZAR VOICEFLOW
        // ========================================
        function initVoiceflow(userId, variables) {
            console.log('üì§ Payload a enviar a VoiceFlow:', JSON.stringify(variables, null, 2));
            
            const config = {
                verify: { projectID: VOICEFLOW_PROJECT_ID },
                url: 'https://general-runtime.voiceflow.com',
                versionID: 'production',
                userID: userId,
                voice: {
                    url: "https://runtime-api.voiceflow.com"
                },
                render: {
                    mode: 'embedded',
                    target: document.getElementById('chat-container')
                },
                assistant: {
                    extensions: [MakeCodeBlocksExtension, SaveStudentInfoExtension],
                    persistence: 'memory'
                },
                launch: {
                    event: {
                        type: 'launch',
                        payload: variables
                    }
                }
            };

            console.log('‚öôÔ∏è Config VoiceFlow:', config);

            if (scriptLoaded && window.voiceflow && window.voiceflow.chat) {
                window.voiceflow.chat.load(config);
                setTimeout(() => generateAndApplyCSS(), 1500);
                setTimeout(() => generateAndApplyCSS(), 3000);
                return;
            }

            const script = document.createElement('script');
            script.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs";
            script.type = "text/javascript";
            script.onload = function() {
                scriptLoaded = true;
                window.voiceflow.chat.load(config);
                setTimeout(() => generateAndApplyCSS(), 1500);
                setTimeout(() => generateAndApplyCSS(), 3000);
            };
            document.head.appendChild(script);
        }

        // ========================================
        // OBSERVER PARA CSS
        // ========================================
        function setupCSSObserver() {
            const container = document.getElementById('chat-container');
            new MutationObserver(() => {
                setTimeout(() => {
                    if (lastCSS) injectCSS(lastCSS);
                }, 500);
            }).observe(container, { childList: true, subtree: true });
        }

        // ========================================
        // INIT
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            initIdentityGrid();
            window.MakeCodeRenderer.init();
            setupCSSObserver();
            userIdInput.focus();
        });
    </script>
</body>
</html>
